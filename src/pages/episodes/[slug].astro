---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const episodes = await getCollection("episodes");
  return episodes.map((ep) => ({
    params: { slug: ep.slug },
    props: { ep },
  }));
}

type Props = {
  ep: CollectionEntry<"episodes">;
};

const { ep } = Astro.props;
const { Content } = await ep.render();

// For previous / next navigation
const all = (await getCollection("episodes")) as CollectionEntry<"episodes">[];
all.sort((a, b) => b.data.episode - a.data.episode);
const idx = all.findIndex((x) => x.slug === ep.slug);
const nextEp = idx > 0 ? all[idx - 1] : null;
const prevEp = idx < all.length - 1 ? all[idx + 1] : null;

// Platform links
const platforms = [
  { label: "Spotify", url: ep.data.spotify },
  { label: "Apple Podcasts", url: ep.data.apple },
  { label: "Amazon Music", url: ep.data.amazon },
  { label: "Audible", url: ep.data.audible },
  { label: "YouTube", url: ep.data.youtube },
].filter((p) => p.url);
---

<BaseLayout title={`Episode ${ep.data.episode} — ${ep.data.title}`}>
  <main class="wrap">

    <!-- Episode Hero -->
    {ep.data.cover && (
      <div class="episode-hero">
        <img
          src={ep.data.cover}
          alt={`Episode ${ep.data.episode} artwork`}
          class="episode-art"
          loading="eager"
        />
      </div>
    )}

    <p class="episode-kicker">Episode {ep.data.episode}</p>
    <h1 class="episode-title">{ep.data.title}</h1>
    <p class="episode-meta">{ep.data.passage} · {ep.data.date}</p>
    {ep.data.summary && <p class="episode-lede">{ep.data.summary}</p>}

    <!-- Spotify Player -->
    {ep.data.spotify && (
      <div class="spotify-player">
        <iframe
          title={`Listen to ${ep.data.title} on Spotify – Five Minutes in the Garden`}
          style="border-radius: 12px;"
          width="100%"
          height="152"
          frameborder="0"
          allowfullscreen
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy"
          src={`https://open.spotify.com/embed/episode/${ep.data.spotify.split('/episode/')[1].split('?')[0]}`}
        ></iframe>
      </div>
    )}

    <hr class="divider" />

    <!-- Listen Links -->
    {platforms.length > 0 && (
      <section aria-label="Listen">
        <p class="section-label">Listen</p>
        <ul class="listen-links">
          {platforms.map((p) => (
            <li>
              <a
                href={p.url}
                target="_blank"
                rel="noopener noreferrer"
                data-platform={p.label.toLowerCase()}
              >
                {p.label} →
              </a>
            </li>
          ))}
        </ul>
        <hr class="divider" />
      </section>
    )}

    <!-- Episode Content -->
    <article class="prose">
      <Content />
    </article>

    <!-- Navigation -->
    <nav class="episode-nav" aria-label="Episode navigation">
      {prevEp ? (
        <a href={`/episodes/${prevEp.slug}`}>
          ← Episode {prevEp.data.episode}: {prevEp.data.title}
        </a>
      ) : (
        <span />
      )}
      {nextEp ? (
        <a href={`/episodes/${nextEp.slug}`}>
          Episode {nextEp.data.episode}: {nextEp.data.title} →
        </a>
      ) : (
        <span />
      )}
    </nav>
  </main>

  <style>
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 42px 22px;
    }

    /* HERO FIX */
    .episode-hero {
      width: 100%;
      max-width: 980px;
      margin: 0 auto 2.75rem;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      aspect-ratio: 16 / 9;
      background: rgba(0, 0, 0, 0.03);
    }

    .episode-art {
  display: block;
  width: 100%;
  height: auto;          /* key */
  max-width: 980px;
  margin: 0 auto 2.75rem;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  object-fit: contain;   /* optional now, harmless */
}

    .episode-kicker {
      font-size: 1.1rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      opacity: 0.8;
      margin: 0 0 0.5rem;
    }

    .episode-title {
      font-weight: 700;
      font-size: clamp(2.1rem, 4vw, 3.1rem);
      line-height: 1.12;
      margin: 0 0 0.85rem;
    }

    .episode-meta {
      font-size: 0.98rem;
      opacity: 0.82;
      margin: 0 0 0.75rem;
    }

    .episode-lede {
      font-size: 1.06rem;
      line-height: 1.7;
      margin: 0.25rem 0 0;
      max-width: 72ch;
      opacity: 0.95;
    }

    .divider {
      border: 0;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      margin: 1.6rem 0;
    }

    .listen-links {
      list-style: none;
      padding: 0;
      margin: 0.35rem 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem 0.75rem;
    }

    .listen-links a {
      padding: 0.35rem 0.6rem;
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 999px;
      text-decoration: none;
      background: rgba(0, 0, 0, 0.015);
    }

    .prose {
      margin-top: 1.35rem;
      max-width: 72ch;
      font-size: 1.06rem;
      line-height: 1.75;
    }

    .episode-nav {
      margin-top: 2.25rem;
      padding-top: 1.35rem;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      font-size: 0.95rem;
    }

    .episode-nav a:last-child {
      text-align: right;
    }

    @media (max-width: 640px) {
      .wrap {
        padding: 32px 18px;
      }

      .episode-nav {
        grid-template-columns: 1fr;
      }

      .episode-nav a:last-child {
        text-align: left;
      }
    }
  </style>
</BaseLayout>